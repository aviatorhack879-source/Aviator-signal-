import telebot
from telebot import types
import random, time, threading, urllib.parse
from datetime import datetime, timedelta

# --- ğŸ” CONFIG ---
BOT_TOKEN = "8402941434:AAFpbeqcIZU5HTeVxxnzjk5XCnyGwgLrzhk"
bot = telebot.TeleBot(BOT_TOKEN, parse_mode="Markdown")

OWNER_ID = 8188755760 # Aapki ID
REAL_UPI = "swatantrsingh42@okhdfcbank" # Aapki UPI ID

user_expiry = {} 

# --- ğŸ•’ LIVE TIMER ENGINE ---
def start_live_timer(chat_id, minutes):
    end_time = datetime.now() + timedelta(minutes=minutes)
    user_expiry[chat_id] = end_time
    timer_msg = bot.send_message(chat_id, f"â³ **VIP ACCESS ACTIVE**\nâ±ï¸ Time Left: {minutes}:00")
    
    while datetime.now() < end_time:
        remaining = end_time - datetime.now()
        mins, secs = divmod(remaining.seconds, 60)
        time_str = f"{mins:02d}:{secs:02d}"
        try:
            bot.edit_message_text(f"â³ **VIP ACCESS ACTIVE**\nâ±ï¸ Time Left: `{time_str}`", chat_id, timer_msg.message_id)
        except: break 
        time.sleep(10) # Battery aur server ke liye 10 sec ka gap

    bot.send_message(chat_id, "âŒ **TIME EXPIRED!** Access khatam.", reply_markup=types.ReplyKeyboardRemove())
    if chat_id in user_expiry: del user_expiry[chat_id]

# --- ğŸ  START ---
@bot.message_handler(commands=["start"])
def start(message):
    welcome = "ğŸ¤– **AVIATOR V10 PRO**\n\nSignals ke liye VIP plan select karein:"
    markup = types.InlineKeyboardMarkup(row_width=1)
    # Yahan saare amounts set hain, kuch bhi nahi katega
    markup.add(
        types.InlineKeyboardButton("ğŸ’° VIP Plan â‚¹2000 (8 Min) âœ…", callback_data="buy_2000_8"),
        types.InlineKeyboardButton("ğŸ’° VIP Plan â‚¹4000 (15 Min) âœ…", callback_data="buy_4000_15"),
        types.InlineKeyboardButton("ğŸ’° VIP Plan â‚¹6000 (30 Min) âœ…", callback_data="buy_6000_30")
    )
    bot.send_message(message.chat.id, welcome, reply_markup=markup)

# --- ğŸ’³ PAYMENT ---
@bot.callback_query_handler(func=lambda c: c.data.startswith("buy_"))
def handle_payment(call):
    _, amt, mins = call.data.split("_")
    upi_url = f"upi://pay?pa={REAL_UPI}&am={amt}&cu=INR&tn=VIP_Signal_{mins}Min"
    qr_api = f"https://api.qrserver.com/v1/create-qr-code/?size=300x300&data={urllib.parse.quote(upi_url)}"
    bot.send_photo(call.message.chat.id, qr_api, caption=f"ğŸ’³ **SCAN & PAY â‚¹{amt}**\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ³ **Validity:** {mins} Minutes\n\nâœ… Pay karke 12-digit UTR bhejein.")

# --- ğŸ›¡ï¸ ADMIN APPROVAL (SSC) ---
@bot.message_handler(func=lambda m: len(m.text) == 12 and m.text.isdigit())
def ask_approval(message):
    bot.send_message(message.chat.id, "â³ **UTR received!** Admin verification ka wait karein.")
    markup = types.InlineKeyboardMarkup()
    # Aap admin panel se decide karoge kitna time dena hai
    markup.add(types.InlineKeyboardButton("âœ… Start 8 Min", callback_data=f"start_{message.chat.id}_8"),
               types.InlineKeyboardButton("âœ… Start 15 Min", callback_data=f"start_{message.chat.id}_15"),
               types.InlineKeyboardButton("âŒ Reject", callback_data=f"rej_{message.chat.id}"))
    bot.send_message(OWNER_ID, f"ğŸ’° **Payment Alert!**\nUser: `{message.chat.id}`\nUTR: `{message.text}`", reply_markup=markup)

@bot.callback_query_handler(func=lambda c: c.data.startswith(("start_", "rej_")))
def process_admin(call):
    data = call.data.split("_")
    uid = int(data[1])
    if data[0] == "start":
        mins = int(data[2])
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        markup.add("NEXT ğŸš€")
        bot.send_message(uid, f"ğŸš€ **VIP ACCESS GRANTED ({mins} Min)!**", reply_markup=markup)
        threading.Thread(target=start_live_timer, args=(uid, mins)).start()
        bot.edit_message_text(f"âœ… Approved for {mins}m", call.message.chat.id, call.message.message_id)
    else:
        bot.send_message(uid, "âŒ **Payment Rejected!**")

@bot.message_handler(func=lambda m: m.text == "NEXT ğŸš€")
def give_signal(message):
    uid = message.chat.id
    if uid != OWNER_ID and (uid not in user_expiry or datetime.now() > user_expiry[uid]):
        bot.send_message(uid, "âŒ **Access Expired!**", reply_markup=types.ReplyKeyboardRemove())
        return
    bot.send_message(uid, f"ğŸš€ **SIGNAL: {round(random.uniform(1.3, 8.5), 2)}x**")

bot.infinity_polling()
